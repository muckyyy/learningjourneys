# PHP-FPM streaming configuration for The Thinking Course
# CRITICAL settings for streaming AI responses (without mod_fcgid)

# General streaming optimizations
<IfModule mod_proxy.c>
    # Disable proxy buffering for streaming responses
    ProxyPreserveHost On
    ProxyVia Off
    
    # Streaming-specific proxy settings  
    ProxyTimeout 300
</IfModule>

# Disable compression and buffering for streaming responses
<IfModule mod_deflate.c>
    # Disable compression for streaming endpoints
    SetEnvIfNoCase Request_URI "/api/" no-gzip dont-vary
    SetEnvIfNoCase Request_URI "/streaming" no-gzip dont-vary  
    SetEnvIfNoCase Request_URI "/chat" no-gzip dont-vary
</IfModule>

# Header optimizations for streaming
<IfModule mod_headers.c>
    # Prevent caching of streaming responses
    Header always set Cache-Control "no-cache, no-store, must-revalidate" "expr=%{REQUEST_URI} =~ m#/(api|streaming|chat)#"
    Header always set Pragma "no-cache" "expr=%{REQUEST_URI} =~ m#/(api|streaming|chat)#"
    Header always set X-Accel-Buffering "no" "expr=%{REQUEST_URI} =~ m#/(api|streaming|chat)#"
    
    # Disable Apache buffering
    Header always set Connection "keep-alive"
</IfModule>

# FastCGI specific streaming settings
<IfModule mod_proxy_fcgi.c>
    # Disable response buffering
    ProxyFCGISetEnvIf "true" PHP_ADMIN_VALUE "output_buffering=0"
    ProxyFCGISetEnvIf "true" PHP_ADMIN_VALUE "zlib.output_compression=0"
    ProxyFCGISetEnvIf "true" PHP_ADMIN_VALUE "implicit_flush=1"
</IfModule>

# Additional buffering control
<IfModule mod_env.c>
    # Disable various forms of buffering for streaming endpoints
    SetEnvIf Request_URI "/(api|streaming|chat)" no-gzip=1
    SetEnvIf Request_URI "/(api|streaming|chat)" no-brotli=1
</IfModule>